<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tyler Brown's Path to Persistence</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Work+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #fafaf8;
            --bg-secondary: #f0f0ed;
            --text: #1a1a1a;
            --text-secondary: #666666;
            --accent: #d4532f;
            --accent-hover: #b8441f;
            --border: #e0e0dc;
            --success: #2d7d4a;
            --card-bg: #ffffff;
        }

        [data-theme="dark"] {
            --bg: #1a1a1a;
            --bg-secondary: #2a2a2a;
            --text: #f0f0f0;
            --text-secondary: #a0a0a0;
            --accent: #ff6b4a;
            --accent-hover: #ff8566;
            --border: #3a3a3a;
            --success: #4ade80;
            --card-bg: #242424;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Work Sans', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .header {
            background: var(--card-bg);
            border-bottom: 2px solid var(--text);
            padding: 2rem 1.5rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
        }

        h1 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 3rem;
            letter-spacing: 2px;
            margin-bottom: 0.25rem;
            color: var(--accent);
            text-transform: uppercase;
        }

        .tagline {
            font-size: 0.95rem;
            color: var(--text-secondary);
            font-weight: 300;
            letter-spacing: 0.5px;
        }

        .theme-toggle {
            position: absolute;
            top: 2rem;
            right: 1.5rem;
            background: var(--card-bg);
            border: 2px solid var(--border);
            border-radius: 50px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.2rem;
        }

        .theme-toggle:hover {
            border-color: var(--accent);
            transform: scale(1.05);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
        }

        .view-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--border);
        }

        .view-tab {
            padding: 1rem 2rem;
            background: none;
            border: none;
            font-family: 'Work Sans', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .view-tab:hover {
            color: var(--text);
        }

        .view-tab.active {
            color: var(--accent);
        }

        .view-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--accent);
        }

        .view-container {
            animation: fadeIn 0.5s ease-out;
        }

        .controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            background: var(--accent);
            color: white;
            border: none;
            font-family: 'Work Sans', sans-serif;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn:hover {
            background: var(--accent-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 83, 47, 0.3);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--card-bg);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .filter-group {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            flex: 1;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text);
            font-family: 'Work Sans', sans-serif;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-btn:hover {
            background: var(--card-bg);
        }

        .filter-btn.active {
            background: var(--text);
            color: var(--bg);
            border-color: var(--text);
        }

        .date-filter {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border);
            background: var(--card-bg);
            font-family: 'Work Sans', sans-serif;
            font-size: 0.9rem;
            color: var(--text);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            padding: 2rem;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--card-bg);
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            border: 3px solid var(--text);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 2px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-secondary);
        }

        .modal-header h2 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.8rem;
            letter-spacing: 1px;
            color: var(--accent);
            text-align: center;
            flex: 1;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: var(--text);
            line-height: 1;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            color: var(--accent);
        }

        .modal-body {
            padding: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input[type="date"],
        select,
        textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            background: var(--bg);
            font-family: 'Work Sans', sans-serif;
            font-size: 1rem;
            color: var(--text);
        }

        input[type="date"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        .photo-upload {
            border: 2px dashed var(--border);
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: var(--bg);
        }

        .photo-upload:hover {
            border-color: var(--accent);
            background: var(--bg-secondary);
        }

        #photoPreviews {
            display: none;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--bg-secondary);
        }

        .photo-preview {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 4px;
        }

        .photo-preview-container {
            position: relative;
            cursor: move;
            transition: opacity 0.3s;
        }

        .photo-preview-container:hover {
            opacity: 0.9;
        }

        .first-photo-indicator {
            position: absolute;
            top: 4px;
            left: 4px;
            background: var(--success);
            color: white;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .photo-remove-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(212, 83, 47, 0.9);
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .photo-remove-btn:hover {
            background: var(--accent);
        }

        #fileInput {
            display: none;
        }

        .activity-select-container {
            position: relative;
        }

        .add-activity-btn {
            margin-top: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            font-size: 0.85rem;
            width: auto;
            display: inline-block;
        }

        /* Grid */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .entry-card {
            background: var(--card-bg);
            border: 2px solid var(--text);
            cursor: pointer;
            transition: all 0.3s;
            overflow: hidden;
            position: relative;
        }

        .entry-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        }

        .entry-image {
            width: 100%;
            height: 280px;
            object-fit: cover;
            display: block;
        }

        .entry-info {
            padding: 1rem;
        }

        .entry-date {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .entry-activity {
            font-weight: 600;
            font-size: 1rem;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .entry-type-badge {
            font-size: 1.2rem;
            opacity: 0.8;
        }

        .entry-notes-preview {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .no-photo-placeholder {
            width: 100%;
            height: 280px;
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--border) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            color: var(--text-secondary);
        }

        /* View Entry Modal */
        .view-modal-body {
            padding: 0;
        }

        .view-entry-photos {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.5rem;
            padding: 1rem;
            background: var(--bg-secondary);
        }

        .view-entry-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .view-entry-image:hover {
            transform: scale(1.05);
        }

        .view-entry-image.single {
            height: 400px;
            grid-column: 1 / -1;
        }

        /* Lightbox */
        .lightbox {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: zoom-out;
        }

        .lightbox-image {
            max-width: 95%;
            max-height: 95vh;
            object-fit: contain;
            cursor: default;
        }

        .lightbox-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 3rem;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            transition: all 0.3s;
        }

        .lightbox-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .lightbox-prev,
        .lightbox-next {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 4rem;
            width: 60px;
            height: 80px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .lightbox-prev {
            left: 20px;
        }

        .lightbox-next {
            right: 20px;
        }

        .lightbox-prev:hover,
        .lightbox-next:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .lightbox-counter {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        /* Tags */
        .tag {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 0.85rem;
            color: var(--text);
        }

        .tag-in-entry {
            background: var(--accent);
            color: white;
            border: none;
            font-weight: 500;
        }

        .tag-filter {
            cursor: pointer;
            transition: all 0.3s;
        }

        .tag-filter:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .tag-filter.active {
            background: var(--text);
            color: var(--bg);
            border-color: var(--text);
        }

        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        /* Calendar */
        .calendar-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 2rem;
        }

        .stats-boxes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-box {
            background: var(--card-bg);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .stat-box h3 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.5rem;
            letter-spacing: 1px;
            margin-bottom: 1rem;
            color: var(--text);
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        .stat-value {
            font-weight: 600;
            color: var(--text);
        }

        .progress-bar {
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
            margin: 1rem 0 0.5rem 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent);
            transition: width 0.3s ease;
            width: 0%;
        }

        .stat-percentage {
            text-align: center;
            font-weight: 600;
            font-size: 1.2rem;
            color: var(--accent);
        }

        /* Missed Activities List */
        .missed-activity-card {
            background: var(--card-bg);
            border: 2px solid var(--border);
            border-left: 4px solid var(--text-secondary);
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s;
        }

        .missed-activity-card:hover {
            border-left-color: var(--accent);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .missed-activity-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .missed-activity-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.5rem;
            letter-spacing: 1px;
            color: var(--text);
        }

        .missed-activity-date {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .missed-activity-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .missed-info-item {
            display: flex;
            flex-direction: column;
        }

        .missed-info-label {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
        }

        .missed-info-value {
            color: var(--text);
            font-weight: 600;
        }

        .missed-reason {
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: 8px;
            color: var(--text);
            font-style: italic;
            margin-top: 1rem;
        }

        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: var(--border);
            border: 1px solid var(--border);
        }

        .calendar-day-header {
            background: var(--bg-secondary);
            padding: 1rem;
            text-align: center;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }

        .calendar-day {
            background: var(--card-bg);
            min-height: 120px;
            padding: 0.5rem;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
        }

        .calendar-day:hover {
            background: var(--bg-secondary);
        }

        .calendar-day.other-month {
            background: var(--bg);
            opacity: 0.4;
        }

        .calendar-day.today {
            background: var(--bg-secondary);
            border: 2px solid var(--accent);
        }

        .day-number {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        .calendar-day.today .day-number {
            color: var(--accent);
        }

        .calendar-entry {
            background: var(--accent);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-bottom: 0.25rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .calendar-entry.planned {
            background: transparent;
            border: 1px dashed var(--accent);
            color: var(--accent);
        }

        .calendar-entry.missed {
            background: transparent;
            border: 1px solid var(--text-secondary);
            color: var(--text-secondary);
            text-decoration: line-through;
        }

        .calendar-entry-thumbnail {
            width: 100%;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 0.25rem;
        }

        .view-entry-content {
            padding: 2rem;
        }

        .view-entry-meta {
            text-align: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border);
        }

        .view-entry-date {
            font-size: 0.95rem;
            color: var(--text-secondary);
        }

        .view-entry-activity {
            font-weight: 600;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .view-entry-notes {
            line-height: 1.7;
            white-space: pre-wrap;
            color: var(--text);
        }

        .view-entry-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 2px solid var(--border);
        }

        .btn-edit,
        .btn-delete {
            padding: 0.75rem 1.5rem;
            border: none;
            font-family: 'Work Sans', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.9rem;
        }

        .btn-edit {
            background: var(--text);
            color: var(--bg);
            flex: 1;
        }

        .btn-edit:hover {
            background: var(--text-secondary);
        }

        .btn-delete {
            background: var(--bg-secondary);
            color: var(--accent);
            border: 1px solid var(--accent);
        }

        .btn-delete:hover {
            background: var(--accent);
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .empty-state h3 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2rem;
            margin-bottom: 0.5rem;
            letter-spacing: 1px;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }

            .grid {
                grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
                gap: 1rem;
            }

            .entry-image,
            .no-photo-placeholder {
                height: 240px;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-group {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Password Protection Screen -->
    <div id="passwordScreen" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg); z-index: 10000; display: flex; align-items: center; justify-content: center;">
        <div style="background: var(--card-bg); padding: 3rem; border-radius: 12px; border: 2px solid var(--border); max-width: 400px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
            <h1 style="font-family: 'Bebas Neue', sans-serif; font-size: 2.5rem; color: var(--accent); margin-bottom: 0.5rem; text-align: center;">Path to Persistence</h1>
            <p style="color: var(--text-secondary); text-align: center; margin-bottom: 2rem;">Enter password to access your tracker</p>
            
            <input type="password" id="passwordInput" placeholder="Enter password" style="width: 100%; padding: 1rem; border: 2px solid var(--border); border-radius: 8px; font-size: 1rem; margin-bottom: 1rem; background: var(--bg); color: var(--text); font-family: 'Work Sans', sans-serif;" onkeypress="if(event.key === 'Enter') checkPassword()">
            
            <button onclick="checkPassword()" style="width: 100%; padding: 1rem; background: var(--accent); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; font-family: 'Work Sans', sans-serif; transition: all 0.3s;" onmouseover="this.style.background='var(--accent-hover)'" onmouseout="this.style.background='var(--accent)'">
                Unlock
            </button>
            
            <div id="passwordError" style="color: #c62828; text-align: center; margin-top: 1rem; display: none;">
                Incorrect password. Try again.
            </div>
        </div>
    </div>

    <div id="mainContent" style="display: none;">
    
    <div class="header">
        <div class="header-content">
            <h1>Tyler Brown's Path to Persistence</h1>
            <p class="tagline">A visual journal of progress, discipline, and growth</p>
            <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle">
                <span id="themeIcon">üåô</span>
            </button>
            <button class="theme-toggle" onclick="openApiSettings()" id="apiSettingsBtn" style="right: 6rem;" title="AI Analysis Settings">
                <span>‚öôÔ∏è</span>
            </button>
        </div>
    </div>

    <div class="container">
        <div class="view-tabs">
            <button class="view-tab active" onclick="switchView('grid')">Grid View</button>
            <button class="view-tab" onclick="switchView('calendar')">Calendar</button>
            <button class="view-tab" onclick="switchView('missed')">Missed Activities</button>
        </div>

        <div id="gridViewContainer" class="view-container">
            <div class="controls">
                <button class="btn" onclick="openCreateModal()">+ New Entry</button>
                <button class="btn-secondary" onclick="exportData()">‚¨áÔ∏è Export Data</button>
                <button class="btn-secondary" onclick="document.getElementById('importFileInput').click()">‚¨ÜÔ∏è Import Data</button>
                <input type="file" id="importFileInput" accept=".json" style="display: none;" onchange="importData(event)">
                <button class="btn" onclick="analyzeProgress()" id="analyzeBtn">ü§ñ Analyze My Progress</button>
            </div>
            
            <!-- AI Analysis Result -->
            <div id="analysisResult" style="display: none; background: var(--card-bg); border: 2px solid var(--accent); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
                <h3 style="font-family: 'Bebas Neue', sans-serif; color: var(--accent); margin-bottom: 1rem;">Claude's Analysis</h3>
                <div id="analysisContent" style="line-height: 1.6;"></div>
                <button class="btn-secondary" onclick="document.getElementById('analysisResult').style.display='none'" style="margin-top: 1rem;">Close</button>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text);">Filter by Type:</label>
                <div id="typeFilters" class="tags-container"></div>
            </div>
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text);">Filter by Tag:</label>
                <div id="tagFilters" class="tags-container"></div>
            </div>
            <div id="grid" class="grid"></div>
        </div>

        <div id="calendarViewContainer" class="view-container" style="display: none;">
            <div class="calendar-controls">
                <button class="btn-secondary" onclick="previousMonth()">‚Äπ Previous</button>
                <h2 id="currentMonthYear" style="flex: 1; text-align: center; font-family: 'Bebas Neue', sans-serif; font-size: 2rem; letter-spacing: 1px;"></h2>
                <button class="btn-secondary" onclick="nextMonth()">Next ‚Ä∫</button>
                <button class="btn" onclick="goToToday()">Today</button>
            </div>
            
            <div class="stats-boxes">
                <div class="stat-box">
                    <h3>This Week's Volume</h3>
                    <p id="weekRange" style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;"></p>
                    <div class="stat-row">
                        <span>Planned:</span>
                        <span id="weekPlanned" class="stat-value">0 min</span>
                    </div>
                    <div class="stat-row">
                        <span>Completed:</span>
                        <span id="weekCompleted" class="stat-value">0 min</span>
                    </div>
                    <div class="progress-bar">
                        <div id="weekProgress" class="progress-fill"></div>
                    </div>
                    <div class="stat-percentage" id="weekPercentage">0%</div>
                </div>
                
                <div class="stat-box">
                    <h3>This Month's Volume</h3>
                    <div class="stat-row">
                        <span>Planned:</span>
                        <span id="monthPlanned" class="stat-value">0 min</span>
                    </div>
                    <div class="stat-row">
                        <span>Completed:</span>
                        <span id="monthCompleted" class="stat-value">0 min</span>
                    </div>
                    <div class="progress-bar">
                        <div id="monthProgress" class="progress-fill"></div>
                    </div>
                    <div class="stat-percentage" id="monthPercentage">0%</div>
                </div>
            </div>
            
            <div id="calendar" class="calendar"></div>
        </div>

        <div id="missedViewContainer" class="view-container" style="display: none;">
            <div style="margin-bottom: 2rem;">
                <h2 style="font-family: 'Bebas Neue', sans-serif; font-size: 2rem; letter-spacing: 1px; margin-bottom: 0.5rem;">Missed Activities</h2>
                <p style="color: var(--text-secondary);">Track what you missed and why - learn from the patterns</p>
            </div>
            <div id="missedTagFilters" class="tags-container" style="margin-bottom: 2rem;"></div>
            <div id="missedList"></div>
        </div>
    </div>

    <!-- Create/Edit Modal -->
    <div id="entryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">New Entry</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Planned Activity Form (for future dates) -->
                <div id="plannedForm" style="display: none;">
                    <p style="color: var(--text-secondary); margin-bottom: 1.5rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                        üìÖ Planning a future activity - just add the basics now, you'll complete the details when you do it!
                    </p>
                    
                    <div class="form-group">
                        <label for="plannedDate">Date</label>
                        <input type="date" id="plannedDate" required>
                    </div>

                    <div class="form-group">
                        <label for="plannedTitle">Activity Type</label>
                        <input type="text" id="plannedTitle" required placeholder="e.g., Zwift Race, Long Run, Leg Day">
                    </div>

                    <div class="form-group">
                        <label for="plannedDuration">Planned Duration (minutes)</label>
                        <input type="number" id="plannedDuration" min="1" required placeholder="e.g., 60">
                    </div>

                    <div class="form-group">
                        <label for="plannedTags">Tags (optional)</label>
                        <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Separate tags with commas</p>
                        <input type="text" id="plannedTags" placeholder="e.g., Zwift, Race, Cardio">
                    </div>

                    <div class="form-group">
                        <label for="plannedNotes">Plan Notes (optional)</label>
                        <textarea id="plannedNotes" placeholder="Any details about this planned activity..."></textarea>
                    </div>

                    <button type="button" class="btn" style="width: 100%;" onclick="savePlannedActivity()">Save Planned Activity</button>
                </div>

                <!-- Regular Entry Form (for today/past OR completing a plan) -->
                <form id="entryForm" onsubmit="saveEntry(event)" style="display: none;">
                    <input type="hidden" id="entryId">
                    <input type="hidden" id="entryStatus">
                    <input type="hidden" id="completingPlanId">
                    
                    <div class="form-group">
                        <label for="entryType">Entry Type</label>
                        <select id="entryType" onchange="updateEntryFormFields()" required style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 8px; font-family: 'Work Sans', sans-serif; background: var(--card-bg); color: var(--text);">
                            <option value="workout">üí™ Workout</option>
                            <option value="blog">üìù Blog / Journal</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="entryDate">Date</label>
                        <input type="date" id="entryDate" required onchange="updateEntryStatus()">
                    </div>

                    <div class="form-group">
                        <label for="entryTitle">Title</label>
                        <input type="text" id="entryTitle" required placeholder="e.g., Morning Zwift Session, Leg Day, 5K Run...">
                    </div>

                    <div class="form-group" id="durationGroup">
                        <label for="actualDuration">Duration (minutes)</label>
                        <input type="number" id="actualDuration" min="1" placeholder="e.g., 60">
                    </div>

                    <div class="form-group">
                        <label for="tags">Tags (optional)</label>
                        <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Separate tags with commas (e.g., Zwift, Cardio, Morning)</p>
                        <input type="text" id="tags" placeholder="e.g., Zwift, Hiking, Strength">
                        <div id="tagPreviews" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;"></div>
                    </div>

                    <div class="form-group" id="photosGroup">
                        <label>Photos (optional)</label>
                        <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">First photo will be the cover image. Drag to reorder.</p>
                        <div id="photoPreviews" style="display: none; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 0.5rem; padding: 0.5rem; margin-bottom: 0.5rem;"></div>
                        <div class="photo-upload" id="photoUpload" onclick="document.getElementById('fileInput').click()">
                            <div id="uploadPlaceholder">
                                <p style="font-size: 2rem; margin-bottom: 0.5rem;">üì∏</p>
                                <p style="color: var(--text-secondary);">Click to upload photos</p>
                                <p style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.5rem;">You can select multiple photos</p>
                            </div>
                        </div>
                        <input type="file" id="fileInput" accept="image/*" multiple onchange="handleFileSelect(event)">
                    </div>

                    <div class="form-group" id="weightGroup">
                        <label for="weight">Weight (kg) - optional</label>
                        <input type="number" id="weight" step="0.1" placeholder="e.g., 95.5">
                    </div>

                    <div class="form-group">
                        <label for="notes">Notes</label>
                        <textarea id="notes" placeholder="Write about today's activity, how you felt, progress made..."></textarea>
                    </div>

                    <button type="submit" class="btn" style="width: 100%;">Save Entry</button>
                </form>
            </div>
        </div>
    </div>

    <!-- View Modal -->
    <div id="viewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Entry Details</h2>
                <button class="close-btn" onclick="closeViewModal()">&times;</button>
            </div>
            <div class="modal-body view-modal-body">
                <div id="viewEntryPhotos" class="view-entry-photos" style="display: none;"></div>
                <div class="view-entry-content">
                    <div class="view-entry-meta">
                        <div class="view-entry-date" id="viewEntryDate"></div>
                    </div>
                    
                    <!-- Completion prompt for planned activities -->
                    <div id="completionPrompt" style="display: none; background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; text-align: center;">
                        <div id="completionQuestion">
                            <h3 style="margin-bottom: 1rem; color: var(--text);">Did you complete this activity?</h3>
                            <div style="display: flex; gap: 1rem; justify-content: center;">
                                <button class="btn" onclick="completeActivity(true)" style="flex: 1; max-width: 200px;">‚úì Yes, I did it!</button>
                                <button class="btn-secondary" onclick="showMissedForm()" style="flex: 1; max-width: 200px;">‚úó Missed it</button>
                            </div>
                        </div>
                        
                        <!-- Missed activity form -->
                        <div id="missedForm" style="display: none; text-align: left; margin-top: 1rem;">
                            <h3 style="margin-bottom: 1rem; color: var(--text); text-align: center;">Why did you miss it?</h3>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Reason (optional)</label>
                                <textarea id="missedReason" placeholder="e.g., Feeling sick, Work emergency, Too tired..." style="width: 100%; min-height: 80px; padding: 0.75rem; border: 2px solid var(--border); border-radius: 8px; font-family: 'Work Sans', sans-serif; resize: vertical;"></textarea>
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Tags (optional)</label>
                                <input type="text" id="missedTags" placeholder="e.g., Sick, Travel, Work" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 8px; font-family: 'Work Sans', sans-serif;">
                                <p style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.25rem;">Separate tags with commas</p>
                            </div>
                            
                            <div style="display: flex; gap: 1rem; justify-content: center;">
                                <button class="btn" onclick="saveMissedActivity()" style="flex: 1;">Save</button>
                                <button class="btn-secondary" onclick="cancelMissedForm()" style="flex: 1;">Cancel</button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="viewEntryTags" class="tags-container" style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border); display: none;"></div>
                    
                    <div id="viewEntryDuration" style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border); display: none;">
                        <span style="color: var(--text-secondary); font-size: 0.9rem;" id="viewDurationLabel">Duration: </span>
                        <span style="font-weight: 600; color: var(--accent);" id="viewDurationValue"></span>
                    </div>
                    
                    <div id="viewEntryWeight" style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border); display: none;">
                        <span style="color: var(--text-secondary); font-size: 0.9rem;">Weight: </span>
                        <span style="font-weight: 600; color: var(--accent);" id="viewEntryWeightValue"></span>
                    </div>
                    <div class="view-entry-notes" id="viewEntryNotes"></div>
                    <div class="view-entry-actions">
                        <button class="btn-edit" onclick="editEntry()">Edit Entry</button>
                        <button class="btn-delete" onclick="deleteEntry()">Delete</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lightbox for full-size photos -->
    <div id="lightbox" class="lightbox" onclick="closeLightbox()" style="display: none;">
        <button class="lightbox-close" onclick="closeLightbox()">&times;</button>
        <button class="lightbox-prev" onclick="navigateLightbox(-1); event.stopPropagation();" style="display: none;">‚Äπ</button>
        <button class="lightbox-next" onclick="navigateLightbox(1); event.stopPropagation();" style="display: none;">‚Ä∫</button>
        <img id="lightboxImage" class="lightbox-image" onclick="event.stopPropagation()">
        <div class="lightbox-counter" id="lightboxCounter" style="display: none;"></div>
    </div>

    <!-- API Settings Modal -->
    <div id="apiSettingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>API Settings</h2>
                <button class="close-btn" onclick="closeApiSettings()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                    To use AI analysis, you need an Anthropic API key. This is separate from your Claude Pro subscription.
                </p>
                
                <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <h4 style="margin-bottom: 0.5rem;">How to get your API key:</h4>
                    <ol style="margin-left: 1.5rem; line-height: 1.8;">
                        <li>Go to <a href="https://console.anthropic.com" target="_blank" style="color: var(--accent);">console.anthropic.com</a></li>
                        <li>Sign up or log in</li>
                        <li>Navigate to "API Keys"</li>
                        <li>Click "Create Key"</li>
                        <li>Copy the key (starts with sk-ant-)</li>
                        <li>Paste it below</li>
                    </ol>
                    <p style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-secondary);">
                        <strong>Cost:</strong> ~$0.01-0.02 per analysis. Pay only when you use it.
                    </p>
                </div>
                
                <div class="form-group">
                    <label for="apiKeyInput">Anthropic API Key</label>
                    <input type="password" id="apiKeyInput" placeholder="sk-ant-xxxxxxxxxxxxx" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 8px; font-family: 'Work Sans', sans-serif; background: var(--card-bg); color: var(--text);">
                    <p style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.5rem;">
                        Your API key is stored locally in your browser and never shared.
                    </p>
                </div>
                
                <div style="display: flex; gap: 1rem;">
                    <button class="btn" onclick="saveApiKey()" style="flex: 1;">Save API Key</button>
                    <button class="btn-secondary" onclick="clearApiKey()" style="flex: 1;">Clear Key</button>
                </div>
                
                <div id="apiKeyStatus" style="margin-top: 1rem; padding: 0.75rem; border-radius: 8px; display: none;"></div>
            </div>
        </div>
    </div>

    <!-- API Settings Modal -->
    <div id="apiSettingsModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>API Settings</h2>
                <button class="close-btn" onclick="closeApiSettings()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 1rem; color: var(--text-secondary);">
                    To use AI analysis, you need an Anthropic API key. This enables Claude to analyze your entries and provide insights.
                </p>
                
                <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <h4 style="margin-bottom: 0.5rem;">How to get your API key:</h4>
                    <ol style="margin-left: 1.5rem; line-height: 1.8;">
                        <li>Go to <a href="https://console.anthropic.com" target="_blank" style="color: var(--accent);">console.anthropic.com</a></li>
                        <li>Sign up or log in</li>
                        <li>Go to "API Keys" section</li>
                        <li>Click "Create Key"</li>
                        <li>Copy the key and paste it below</li>
                    </ol>
                </div>
                
                <div class="form-group">
                    <label for="apiKeyInput">Anthropic API Key</label>
                    <input type="password" id="apiKeyInput" placeholder="sk-ant-xxxxxxxxxxxxx" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 8px; font-family: monospace; background: var(--card-bg); color: var(--text);">
                    <p style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.5rem;">
                        Your key is stored locally in your browser and never shared.
                    </p>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button class="btn" onclick="saveApiKey()" style="flex: 1;">Save API Key</button>
                    <button class="btn-secondary" onclick="clearApiKey()" style="flex: 1;">Clear Key</button>
                </div>
                
                <div id="apiKeyStatus" style="margin-top: 1rem; padding: 0.75rem; border-radius: 8px; display: none;"></div>
            </div>
        </div>
    </div>

    <script>
        // VERSION: 2025-01-20-v9
        console.log('Script loaded - Version 2025-01-20-v9');
        
        const STORAGE_KEY = 'persistence-blog-entries';
        const THEME_KEY = 'persistence-theme';
        const API_KEY_STORAGE = 'anthropic-api-key';
        let currentPhotosData = [];
        let currentViewingEntry = null;
        let lightboxPhotos = [];
        let currentLightboxIndex = 0;
        let currentTagFilter = null;
        let currentTypeFilter = null;
        let currentMissedTagFilter = null;
        let currentView = 'grid';
        let currentCalendarDate = new Date();

        // Theme functions
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem(THEME_KEY, newTheme);
            
            // Update icon
            document.getElementById('themeIcon').textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem(THEME_KEY) || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            document.getElementById('themeIcon').textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }

        // Load theme on page load
        loadTheme();

        // Get today's date in local timezone
        function getTodayString() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Initialize
        function init() {
            document.getElementById('entryDate').value = getTodayString();
            renderGrid();
            updateTagFilters();
            renderCalendar();
        }

        // Switch between grid and calendar views
        function switchView(view) {
            currentView = view;
            
            // Update tab buttons
            document.querySelectorAll('.view-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // Show/hide containers
            document.getElementById('gridViewContainer').style.display = 'none';
            document.getElementById('calendarViewContainer').style.display = 'none';
            document.getElementById('missedViewContainer').style.display = 'none';
            
            if (view === 'grid') {
                document.getElementById('gridViewContainer').style.display = 'block';
            } else if (view === 'calendar') {
                document.getElementById('calendarViewContainer').style.display = 'block';
                renderCalendar();
            } else if (view === 'missed') {
                document.getElementById('missedViewContainer').style.display = 'block';
                renderMissedList();
            }
        }

        // Update entry status based on date
        function updateEntryStatus() {
            const entryDate = document.getElementById('entryDate').value;
            const today = getTodayString();
            const status = entryDate > today ? 'planned' : 'completed';
            document.getElementById('entryStatus').value = status;
            
            // Show/hide optional fields for planned entries
            const photosGroup = document.getElementById('photosGroup');
            const weightGroup = document.getElementById('weightGroup');
            
            if (status === 'planned') {
                photosGroup.style.display = 'none';
                weightGroup.style.display = 'none';
            } else {
                photosGroup.style.display = 'block';
                weightGroup.style.display = 'block';
            }
        }

        // Update form fields based on entry type
        function updateEntryFormFields() {
            const entryType = document.getElementById('entryType').value;
            const durationGroup = document.getElementById('durationGroup');
            const weightGroup = document.getElementById('weightGroup');
            
            if (entryType === 'workout') {
                durationGroup.style.display = 'block';
                weightGroup.style.display = 'block';
                document.getElementById('entryTitle').placeholder = 'e.g., Morning Zwift Session';
                document.getElementById('tags').placeholder = 'e.g., Zwift, Cardio';
                document.getElementById('notes').placeholder = 'Write about your activity';
            } else if (entryType === 'blog') {
                durationGroup.style.display = 'none';
                weightGroup.style.display = 'none';
                document.getElementById('entryTitle').placeholder = 'e.g., Trip to the Mountains';
                document.getElementById('tags').placeholder = 'e.g., Personal, Travel';
                document.getElementById('notes').placeholder = 'Write your thoughts';
            }
        }

        // Update tag filter buttons
        function updateTagFilters() {
            const entries = loadEntries();
            const allTags = new Set();
            
            // Only get tags from completed entries (not missed)
            entries.forEach(entry => {
                if (entry.tags && Array.isArray(entry.tags) && entry.status !== 'missed') {
                    entry.tags.forEach(tag => allTags.add(tag));
                }
            });
            
            const tagFiltersContainer = document.getElementById('tagFilters');
            
            if (allTags.size === 0) {
                tagFiltersContainer.innerHTML = '<p style="color: var(--text-secondary); font-size: 0.9rem;">No tags yet - add tags to your entries to filter by them!</p>';
                return;
            }
            
            const sortedTags = Array.from(allTags).sort();
            
            tagFiltersContainer.innerHTML = `
                <button class="tag tag-filter ${currentTagFilter === null ? 'active' : ''}" onclick="filterByTag(null)">All</button>
                ${sortedTags.map(tag => `
                    <button class="tag tag-filter ${currentTagFilter === tag ? 'active' : ''}" onclick="filterByTag('${tag}')">${tag}</button>
                `).join('')}
            `;
        }

        // Filter by tag
        function filterByTag(tag) {
            currentTagFilter = tag;
            updateTagFilters();
            renderGrid();
        }

        // Update type filter buttons
        function updateTypeFilters() {
            const typeFiltersContainer = document.getElementById('typeFilters');
            
            typeFiltersContainer.innerHTML = `
                <button class="tag tag-filter ${currentTypeFilter === null ? 'active' : ''}" onclick="filterByType(null)">All</button>
                <button class="tag tag-filter ${currentTypeFilter === 'workout' ? 'active' : ''}" onclick="filterByType('workout')">üí™ Workouts</button>
                <button class="tag tag-filter ${currentTypeFilter === 'blog' ? 'active' : ''}" onclick="filterByType('blog')">üìù Blog</button>
            `;
        }

        // Filter by entry type
        function filterByType(type) {
            currentTypeFilter = type;
            renderGrid();
        }

        // Load data
        function loadEntries() {
            const data = localStorage.getItem(STORAGE_KEY);
            return data ? JSON.parse(data) : [];
        }

        // Save data
        function saveEntries(entries) {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    alert('Storage limit reached! Try using fewer photos or lower quality images. Your entry was not saved.');
                    console.error('Storage quota exceeded:', e);
                } else {
                    alert('Failed to save entry. Please try again.');
                    console.error('Save error:', e);
                }
                throw e;
            }
        }

        // Compress image before storing
        function compressImage(dataUrl, maxWidth = 1200, quality = 0.7) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    // Calculate new dimensions
                    if (width > maxWidth) {
                        height *= maxWidth / width;
                        width = maxWidth;
                    }

                    canvas.width = width;
                    canvas.height = height;

                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    // Convert to JPEG with compression
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.src = dataUrl;
            });
        }

        // Handle file selection
        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;

            const previewsContainer = document.getElementById('photoPreviews');
            previewsContainer.style.display = 'grid';

            // Process each file
            let processed = 0;
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    // Compress the image before adding to array
                    const compressed = await compressImage(e.target.result);
                    currentPhotosData.push(compressed);
                    
                    processed++;
                    if (processed === files.length) {
                        renderPhotoPreviews();
                        // Clear the file input so the same file can be selected again
                        event.target.value = '';
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        // Render photo previews in modal
        function renderPhotoPreviews() {
            const container = document.getElementById('photoPreviews');
            container.innerHTML = currentPhotosData.map((photo, index) => `
                <div class="photo-preview-container" draggable="true" data-index="${index}" 
                     ondragstart="handleDragStart(event)" 
                     ondragover="handleDragOver(event)" 
                     ondrop="handleDrop(event)"
                     ondragend="handleDragEnd(event)">
                    <img src="${photo}" class="photo-preview">
                    <button type="button" class="photo-remove-btn" onclick="removePhoto(${index}); event.stopPropagation();">&times;</button>
                    ${index === 0 ? '<div class="first-photo-indicator">Cover</div>' : ''}
                </div>
            `).join('');
        }

        // Drag and drop functions
        let draggedIndex = null;

        function handleDragStart(e) {
            draggedIndex = parseInt(e.currentTarget.getAttribute('data-index'));
            e.currentTarget.style.opacity = '0.4';
        }

        function handleDragOver(e) {
            e.preventDefault();
            return false;
        }

        function handleDrop(e) {
            e.stopPropagation();
            e.preventDefault();
            
            const dropIndex = parseInt(e.currentTarget.getAttribute('data-index'));
            
            if (draggedIndex !== null && draggedIndex !== dropIndex) {
                // Reorder the photos array
                const draggedPhoto = currentPhotosData[draggedIndex];
                currentPhotosData.splice(draggedIndex, 1);
                currentPhotosData.splice(dropIndex, 0, draggedPhoto);
                
                renderPhotoPreviews();
            }
            
            return false;
        }

        function handleDragEnd(e) {
            e.currentTarget.style.opacity = '1';
            draggedIndex = null;
        }

        // Remove a photo from the array
        function removePhoto(index) {
            currentPhotosData.splice(index, 1);
            
            if (currentPhotosData.length === 0) {
                const previewsContainer = document.getElementById('photoPreviews');
                previewsContainer.style.display = 'none';
            } else {
                renderPhotoPreviews();
            }
        }

        // Open create modal
        function openCreateModal() {
            const today = getTodayString();
            const selectedDate = getTodayString(); // Default to today
            
            openModalForDate(selectedDate);
        }

        // Open modal for specific date
        function openModalForDate(dateString) {
            const today = getTodayString();
            const isFuture = dateString > today;
            
            document.getElementById('modalTitle').textContent = isFuture ? 'Plan Activity' : 'New Entry';
            
            // Show appropriate form
            const plannedForm = document.getElementById('plannedForm');
            const entryForm = document.getElementById('entryForm');
            
            if (isFuture) {
                // Show planned activity form
                plannedForm.style.display = 'block';
                entryForm.style.display = 'none';
                
                document.getElementById('plannedDate').value = dateString;
                document.getElementById('plannedTitle').value = '';
                document.getElementById('plannedTags').value = '';
                document.getElementById('plannedNotes').value = '';
            } else {
                // Show regular entry form
                plannedForm.style.display = 'none';
                entryForm.style.display = 'block';
                
                document.getElementById('entryForm').reset();
                document.getElementById('entryId').value = '';
                document.getElementById('entryDate').value = dateString;
                document.getElementById('tags').value = '';
                document.getElementById('completingPlanId').value = '';
                document.getElementById('entryType').value = 'workout'; // Default to workout
                currentPhotosData = [];
                
                const previewsContainer = document.getElementById('photoPreviews');
                previewsContainer.style.display = 'none';
                previewsContainer.innerHTML = '';
                
                updateEntryStatus();
                updateEntryFormFields(); // Initialize form fields based on type
            }
            
            document.getElementById('entryModal').classList.add('active');
        }

        // Save planned activity
        function savePlannedActivity() {
            const entries = loadEntries();
            
            const tagsValue = document.getElementById('plannedTags').value;
            const tags = tagsValue
                .split(',')
                .map(tag => tag.trim())
                .filter(tag => tag.length > 0);
            
            const entry = {
                id: Date.now().toString(),
                date: document.getElementById('plannedDate').value,
                title: document.getElementById('plannedTitle').value,
                tags: tags,
                status: 'planned',
                plannedDuration: parseInt(document.getElementById('plannedDuration').value) || 0,
                actualDuration: null,
                notes: document.getElementById('plannedNotes').value,
                photos: [],
                weight: null,
                timestamp: Date.now()
            };
            
            entries.push(entry);
            
            try {
                saveEntries(entries);
                closeModal();
                renderCalendar();
                updateTagFilters();
            } catch (e) {
                console.error('Failed to save planned activity:', e);
                alert('Failed to save. Please try again.');
            }
        }

        // Close modal
        function closeModal() {
            document.getElementById('entryModal').classList.remove('active');
        }

        // Save entry
        function saveEntry(event) {
            event.preventDefault();
            console.log('Save entry called');
            
            const entries = loadEntries();
            const id = document.getElementById('entryId').value;
            
            const weightValue = document.getElementById('weight').value;
            const tagsValue = document.getElementById('tags').value;
            const status = document.getElementById('entryStatus').value || 'completed';
            const actualDurationValue = document.getElementById('actualDuration').value;
            const entryType = document.getElementById('entryType').value || 'workout';
            
            // Parse tags from comma-separated string
            const tags = tagsValue
                .split(',')
                .map(tag => tag.trim())
                .filter(tag => tag.length > 0);
            
            const entry = {
                id: id || Date.now().toString(),
                date: document.getElementById('entryDate').value,
                title: document.getElementById('entryTitle').value,
                type: entryType,
                tags: tags,
                status: status,
                actualDuration: actualDurationValue ? parseInt(actualDurationValue) : null,
                weight: weightValue ? parseFloat(weightValue) : null,
                notes: document.getElementById('notes').value,
                photos: currentPhotosData,
                timestamp: Date.now()
            };
            
            // If updating an existing entry, preserve plannedDuration
            if (id) {
                const existingEntry = entries.find(e => e.id === id);
                if (existingEntry && existingEntry.plannedDuration) {
                    entry.plannedDuration = existingEntry.plannedDuration;
                }
            }

            console.log('Saving entry:', entry);
            console.log('Total photos:', currentPhotosData.length);

            if (id) {
                // Update existing
                const index = entries.findIndex(e => e.id === id);
                if (index !== -1) {
                    entries[index] = entry;
                }
            } else {
                // Add new
                entries.push(entry);
            }

            try {
                saveEntries(entries);
                console.log('Entry saved successfully');
                closeModal();
                renderGrid();
                renderCalendar();
                updateTagFilters();
            } catch (e) {
                console.error('Failed to save entry:', e);
                // Modal stays open so user can try again with fewer photos
            }
        }

        // Format date for display
        function formatDate(dateString) {
            const date = new Date(dateString + 'T00:00:00');
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return `${months[date.getMonth()]} ${date.getDate()}, ${date.getFullYear()}`;
        }

        // Render grid
        function renderGrid() {
            const entries = loadEntries();
            const grid = document.getElementById('grid');
            const today = getTodayString();

            console.log('Today:', today);
            console.log('All entries:', entries.map(e => ({ date: e.date, title: e.title })));

            // Filter to only show completed entries (today or past AND status is completed or no status)
            let filtered = entries.filter(entry => {
                const isDateValid = entry.date <= today;
                const isCompleted = !entry.status || entry.status === 'completed'; // Old entries have no status, treat as completed
                const shouldShow = isDateValid && isCompleted;
                console.log(`Entry "${entry.title}" (${entry.date}, status: ${entry.status || 'none'}): ${shouldShow ? 'SHOW' : 'HIDE'}`);
                return shouldShow;
            });

            console.log('Filtered entries for grid:', filtered.length);

            // Filter by entry type if one is selected
            if (currentTypeFilter) {
                filtered = filtered.filter(entry => {
                    const entryType = entry.type || 'workout';
                    return entryType === currentTypeFilter;
                });
            }

            // Filter by tag if one is selected
            if (currentTagFilter) {
                filtered = filtered.filter(entry => 
                    entry.tags && entry.tags.includes(currentTagFilter)
                );
            }

            // Update filters
            updateTypeFilters();
            updateTagFilters();

            // Sort by date (newest first)
            const sorted = filtered.sort((a, b) => new Date(b.date) - new Date(a.date));

            if (sorted.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üèÉ</div>
                        <h3>No Entries Yet</h3>
                        <p>Start documenting your path to persistence!</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = sorted.map(entry => {
                // Handle both old single photo format and new photos array
                const photos = entry.photos || (entry.photo ? [entry.photo] : []);
                const firstPhoto = photos.length > 0 ? photos[0] : null;
                
                const photoHtml = firstPhoto
                    ? `<img src="${firstPhoto}" alt="" class="entry-image">`
                    : `<div class="no-photo-placeholder">üìù</div>`;
                
                // Handle backward compatibility: use title if available, otherwise use old activity field
                const displayTitle = entry.title || entry.activity || 'Untitled';
                
                // Entry type indicator
                const entryType = entry.type || 'workout'; // Default to workout for old entries
                const typeIcon = entryType === 'blog' ? 'üìù' : 'üí™';
                const typeLabel = entryType === 'blog' ? 'Blog' : 'Workout';
                
                const notesPreview = entry.notes 
                    ? `<div class="entry-notes-preview">${entry.notes}</div>`
                    : '';

                const tagsHtml = entry.tags && entry.tags.length > 0
                    ? `<div class="tags-container" style="margin-top: 0.5rem;">
                        ${entry.tags.map(tag => `<span class="tag tag-in-entry">${tag}</span>`).join('')}
                       </div>`
                    : '';

                return `
                    <div class="entry-card" onclick="viewEntry('${entry.id}')">
                        ${photoHtml}
                        <div class="entry-info">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <div class="entry-date">${formatDate(entry.date)}</div>
                                <span class="entry-type-badge" title="${typeLabel}">${typeIcon}</span>
                            </div>
                            <div class="entry-activity">${displayTitle}</div>
                            ${tagsHtml}
                            ${notesPreview}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // View entry
        function viewEntry(id) {
            const entries = loadEntries();
            const entry = entries.find(e => e.id === id);
            if (!entry) return;

            currentViewingEntry = entry;

            // Set modal title to entry title
            const entryTitle = entry.title || entry.activity || 'Untitled';
            document.querySelector('#viewModal .modal-header h2').textContent = entryTitle;

            document.getElementById('viewEntryDate').textContent = formatDate(entry.date);
            
            // Show different notes based on status
            if (entry.status === 'missed' && entry.missedReason) {
                document.getElementById('viewEntryNotes').textContent = `Missed - Reason: ${entry.missedReason}`;
            } else {
                document.getElementById('viewEntryNotes').textContent = entry.notes || 'No notes added.';
            }

            // Show completion prompt for planned activities on/after their date
            const today = getTodayString();
            const completionPrompt = document.getElementById('completionPrompt');
            if (entry.status === 'planned' && entry.date <= today) {
                completionPrompt.style.display = 'block';
            } else {
                completionPrompt.style.display = 'none';
            }

            // Display tags if present
            const tagsContainer = document.getElementById('viewEntryTags');
            if (entry.tags && entry.tags.length > 0) {
                tagsContainer.innerHTML = entry.tags.map(tag => 
                    `<span class="tag tag-in-entry">${tag}</span>`
                ).join('');
                tagsContainer.style.display = 'flex';
            } else {
                tagsContainer.style.display = 'none';
            }

            // Display duration (planned or actual based on status)
            const durationContainer = document.getElementById('viewEntryDuration');
            const durationLabel = document.getElementById('viewDurationLabel');
            const durationValue = document.getElementById('viewDurationValue');
            
            if (entry.status === 'planned' && entry.plannedDuration) {
                durationLabel.textContent = 'Planned Duration: ';
                durationValue.textContent = `${entry.plannedDuration} min`;
                durationContainer.style.display = 'block';
            } else if (entry.actualDuration) {
                durationLabel.textContent = 'Duration: ';
                durationValue.textContent = `${entry.actualDuration} min`;
                durationContainer.style.display = 'block';
            } else {
                durationContainer.style.display = 'none';
            }

            // Display weight if present
            const weightContainer = document.getElementById('viewEntryWeight');
            const weightValue = document.getElementById('viewEntryWeightValue');
            if (entry.weight) {
                weightValue.textContent = `${entry.weight} kg`;
                weightContainer.style.display = 'block';
            } else {
                weightContainer.style.display = 'none';
            }

            const photosContainer = document.getElementById('viewEntryPhotos');
            
            // Handle both old single photo format and new photos array
            const photos = entry.photos || (entry.photo ? [entry.photo] : []);
            
            if (photos.length > 0) {
                const singleClass = photos.length === 1 ? 'single' : '';
                photosContainer.innerHTML = photos.map((photo, index) => 
                    `<img src="${photo}" alt="" class="view-entry-image ${singleClass}" onclick="openLightbox(${index}); event.stopPropagation();">`
                ).join('');
                photosContainer.style.display = 'grid';
            } else {
                photosContainer.style.display = 'none';
            }

            document.getElementById('viewModal').classList.add('active');
        }

        // Complete or miss a planned activity
        function completeActivity(completed) {
            if (!currentViewingEntry) return;
            
            // Store the entry data before closing modal
            const entryToComplete = currentViewingEntry;
            
            if (completed) {
                // Close view modal first
                closeViewModal();
                
                // Open entry form pre-filled with planned data
                document.getElementById('modalTitle').textContent = 'Complete Activity';
                const plannedForm = document.getElementById('plannedForm');
                const entryForm = document.getElementById('entryForm');
                
                plannedForm.style.display = 'none';
                entryForm.style.display = 'block';
                
                document.getElementById('entryId').value = entryToComplete.id;
                document.getElementById('entryDate').value = entryToComplete.date;
                document.getElementById('entryTitle').value = entryToComplete.title;
                document.getElementById('tags').value = entryToComplete.tags ? entryToComplete.tags.join(', ') : '';
                document.getElementById('notes').value = entryToComplete.notes || '';
                document.getElementById('entryStatus').value = 'completed';
                document.getElementById('weight').value = '';
                
                // Pre-fill actual duration with planned duration as a suggestion
                document.getElementById('actualDuration').value = entryToComplete.plannedDuration || '';
                
                currentPhotosData = [];
                const previewsContainer = document.getElementById('photoPreviews');
                previewsContainer.style.display = 'none';
                previewsContainer.innerHTML = '';
                
                // Show photo and weight fields
                document.getElementById('photosGroup').style.display = 'block';
                document.getElementById('weightGroup').style.display = 'block';
                
                document.getElementById('entryModal').classList.add('active');
            }
        }

        // Show the missed activity form
        function showMissedForm() {
            document.getElementById('completionQuestion').style.display = 'none';
            document.getElementById('missedForm').style.display = 'block';
        }

        // Cancel missed form and go back to question
        function cancelMissedForm() {
            document.getElementById('missedForm').style.display = 'none';
            document.getElementById('completionQuestion').style.display = 'block';
            document.getElementById('missedReason').value = '';
            document.getElementById('missedTags').value = '';
        }

        // Save missed activity with reason and tags
        function saveMissedActivity() {
            if (!currentViewingEntry) return;
            
            const entries = loadEntries();
            const index = entries.findIndex(e => e.id === currentViewingEntry.id);
            
            if (index !== -1) {
                const missedReason = document.getElementById('missedReason').value;
                const missedTagsValue = document.getElementById('missedTags').value;
                
                // Parse missed tags
                const missedTags = missedTagsValue
                    .split(',')
                    .map(tag => tag.trim())
                    .filter(tag => tag.length > 0);
                
                // Update entry
                entries[index].status = 'missed';
                entries[index].missedReason = missedReason;
                
                // Combine existing tags with missed tags
                const existingTags = entries[index].tags || [];
                const allTags = [...new Set([...existingTags, ...missedTags])]; // Remove duplicates
                entries[index].tags = allTags;
                
                saveEntries(entries);
            }
            
            // Reset form
            document.getElementById('missedReason').value = '';
            document.getElementById('missedTags').value = '';
            
            closeViewModal();
            renderCalendar();
            renderMissedList();
            updateTagFilters();
        }

        // Open lightbox with photo
        function openLightbox(index) {
            // Get photos from current viewing entry
            const photos = currentViewingEntry.photos || (currentViewingEntry.photo ? [currentViewingEntry.photo] : []);
            lightboxPhotos = photos;
            currentLightboxIndex = index;
            
            updateLightboxImage();
            document.getElementById('lightbox').style.display = 'flex';
        }

        // Update lightbox image and controls
        function updateLightboxImage() {
            document.getElementById('lightboxImage').src = lightboxPhotos[currentLightboxIndex];
            
            const prevBtn = document.querySelector('.lightbox-prev');
            const nextBtn = document.querySelector('.lightbox-next');
            const counter = document.getElementById('lightboxCounter');
            
            // Show/hide navigation based on number of photos
            if (lightboxPhotos.length > 1) {
                prevBtn.style.display = 'flex';
                nextBtn.style.display = 'flex';
                counter.style.display = 'block';
                counter.textContent = `${currentLightboxIndex + 1} / ${lightboxPhotos.length}`;
            } else {
                prevBtn.style.display = 'none';
                nextBtn.style.display = 'none';
                counter.style.display = 'none';
            }
        }

        // Navigate lightbox
        function navigateLightbox(direction) {
            currentLightboxIndex += direction;
            
            // Wrap around
            if (currentLightboxIndex < 0) {
                currentLightboxIndex = lightboxPhotos.length - 1;
            } else if (currentLightboxIndex >= lightboxPhotos.length) {
                currentLightboxIndex = 0;
            }
            
            updateLightboxImage();
        }

        // Close lightbox
        function closeLightbox() {
            document.getElementById('lightbox').style.display = 'none';
            lightboxPhotos = [];
            currentLightboxIndex = 0;
        }

        // Close view modal
        function closeViewModal() {
            document.getElementById('viewModal').classList.remove('active');
            currentViewingEntry = null;
        }

        // Edit entry
        function editEntry() {
            console.log('editEntry called');
            console.log('currentViewingEntry:', currentViewingEntry);
            
            if (!currentViewingEntry) {
                console.error('No entry to edit');
                return;
            }

            // Store the entry data before closing modal
            const entryToEdit = currentViewingEntry;

            console.log('Setting modal title');
            document.getElementById('modalTitle').textContent = 'Edit Entry';
            
            // Show the correct form based on entry status
            const plannedForm = document.getElementById('plannedForm');
            const entryForm = document.getElementById('entryForm');
            
            if (entryToEdit.status === 'planned') {
                // Edit planned activity
                plannedForm.style.display = 'block';
                entryForm.style.display = 'none';
                
                document.getElementById('plannedDate').value = entryToEdit.date;
                document.getElementById('plannedTitle').value = entryToEdit.title || '';
                document.getElementById('plannedDuration').value = entryToEdit.plannedDuration || '';
                document.getElementById('plannedTags').value = entryToEdit.tags ? entryToEdit.tags.join(', ') : '';
                document.getElementById('plannedNotes').value = entryToEdit.notes || '';
                
                // Store ID for updating
                // TODO: Add hidden ID field to planned form
            } else {
                // Edit completed/regular entry
                plannedForm.style.display = 'none';
                entryForm.style.display = 'block';
                
                console.log('Looking for form fields');
                const entryIdField = document.getElementById('entryId');
                const entryDateField = document.getElementById('entryDate');
                const entryTitleField = document.getElementById('entryTitle');
                const notesField = document.getElementById('notes');
                
                console.log('Found fields:', {
                    entryId: !!entryIdField,
                    entryDate: !!entryDateField,
                    entryTitle: !!entryTitleField,
                    notes: !!notesField
                });
                
                if (!entryIdField || !entryDateField || !entryTitleField || !notesField) {
                    console.error('Form fields not found. Please refresh the page.');
                    alert('Error loading edit form. Please refresh the page and try again.');
                    return;
                }
                
                console.log('Populating form with entry data');
                entryIdField.value = entryToEdit.id;
                entryDateField.value = entryToEdit.date;
                // Handle backward compatibility
                entryTitleField.value = entryToEdit.title || entryToEdit.activity || '';
                notesField.value = entryToEdit.notes || '';
                
                // Load status (default to completed for old entries)
                const statusField = document.getElementById('entryStatus');
                if (statusField) {
                    statusField.value = entryToEdit.status || 'completed';
                }
                
                // Load entry type (default to workout for old entries)
                const entryTypeField = document.getElementById('entryType');
                if (entryTypeField) {
                    entryTypeField.value = entryToEdit.type || 'workout';
                    updateEntryFormFields(); // Update field visibility based on type
                }
                
                // Load tags if present
                const tagsField = document.getElementById('tags');
                if (tagsField && entryToEdit.tags) {
                    tagsField.value = entryToEdit.tags.join(', ');
                }
                
                // Load actual duration if present
                const actualDurationField = document.getElementById('actualDuration');
                if (actualDurationField) {
                    actualDurationField.value = entryToEdit.actualDuration || '';
                }
                
                // Load weight if present
                const weightField = document.getElementById('weight');
                if (weightField) {
                    weightField.value = entryToEdit.weight || '';
                }
                
                // Update form fields visibility based on status
                updateEntryStatus();

                // Handle both old single photo format and new photos array
                currentPhotosData = entryToEdit.photos || (entryToEdit.photo ? [entryToEdit.photo] : []);
                console.log('Loaded photos:', currentPhotosData.length);

                const previewsContainer = document.getElementById('photoPreviews');

                if (currentPhotosData.length > 0) {
                    renderPhotoPreviews();
                    previewsContainer.style.display = 'grid';
                } else {
                    previewsContainer.style.display = 'none';
                }
            }

            console.log('Opening entry modal');
            document.getElementById('entryModal').classList.add('active');
            
            console.log('Closing view modal');
            closeViewModal();
            
            console.log('Edit entry complete');
        }

        // Delete entry
        function deleteEntry() {
            if (!currentViewingEntry) return;

            if (!confirm('Are you sure you want to delete this entry? This cannot be undone.')) {
                return;
            }

            const entries = loadEntries();
            const filtered = entries.filter(e => e.id !== currentViewingEntry.id);
            saveEntries(filtered);

            closeViewModal();
            renderGrid();
            renderCalendar();
            updateTagFilters();
        }

        // Calendar functions
        function previousMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderCalendar();
        }

        function goToToday() {
            currentCalendarDate = new Date();
            renderCalendar();
        }

        function renderCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            // Update header
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                              'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('currentMonthYear').textContent = `${monthNames[month]} ${year}`;
            
            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            
            // Get entries for this month
            const entries = loadEntries();
            const today = getTodayString();
            
            // Update stats
            updateStats(entries);
            
            // Build calendar HTML
            let html = '';
            
            // Day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                html += `<div class="calendar-day-header">${day}</div>`;
            });
            
            // Previous month's trailing days
            const prevMonthDays = new Date(year, month, 0).getDate();
            for (let i = startingDayOfWeek - 1; i >= 0; i--) {
                const day = prevMonthDays - i;
                html += `<div class="calendar-day other-month"><div class="day-number">${day}</div></div>`;
            }
            
            // Current month's days
            for (let day = 1; day <= daysInMonth; day++) {
                const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isToday = dateString === today;
                const dayEntries = entries.filter(e => e.date === dateString);
                
                let classes = 'calendar-day';
                if (isToday) classes += ' today';
                
                let entriesHtml = '';
                dayEntries.forEach(entry => {
                    const status = entry.status || 'completed';
                    let entryClass = 'calendar-entry';
                    
                    if (status === 'planned') {
                        entryClass += ' planned';
                    } else if (status === 'missed') {
                        entryClass += ' missed';
                    }
                    
                    const firstPhoto = entry.photos && entry.photos.length > 0 ? entry.photos[0] : null;
                    
                    if (firstPhoto && status === 'completed') {
                        entriesHtml += `<img src="${firstPhoto}" class="calendar-entry-thumbnail" onclick="viewEntry('${entry.id}'); event.stopPropagation();">`;
                    }
                    
                    const statusIcon = status === 'missed' ? '‚úó ' : (status === 'planned' ? 'üìÖ ' : '');
                    
                    // Add duration to the display
                    let durationText = '';
                    if (status === 'planned' && entry.plannedDuration) {
                        durationText = ` | ${entry.plannedDuration} min`;
                    } else if (entry.actualDuration) {
                        durationText = ` | ${entry.actualDuration} min`;
                    }
                    
                    entriesHtml += `<div class="${entryClass}" onclick="viewEntry('${entry.id}'); event.stopPropagation();">${statusIcon}${entry.title}${durationText}</div>`;
                });
                
                html += `
                    <div class="${classes}" onclick="openCreateModalForDate('${dateString}')">
                        <div class="day-number">${day}</div>
                        ${entriesHtml}
                    </div>
                `;
            }
            
            // Next month's leading days
            const remainingDays = 42 - (startingDayOfWeek + daysInMonth);
            for (let day = 1; day <= remainingDays; day++) {
                html += `<div class="calendar-day other-month"><div class="day-number">${day}</div></div>`;
            }
            
            document.getElementById('calendar').innerHTML = html;
        }

        // Update weekly and monthly stats
        function updateStats(entries) {
            const today = new Date();
            const currentYear = currentCalendarDate.getFullYear();
            const currentMonth = currentCalendarDate.getMonth();
            
            // Get start of current week (Sunday)
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay());
            startOfWeek.setHours(0, 0, 0, 0);
            
            // Get end of current week (Saturday)
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            endOfWeek.setHours(23, 59, 59, 999);
            
            // Format week range
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                              'July', 'August', 'September', 'October', 'November', 'December'];
            const startMonth = monthNames[startOfWeek.getMonth()];
            const endMonth = monthNames[endOfWeek.getMonth()];
            const startDay = startOfWeek.getDate();
            const endDay = endOfWeek.getDate();
            
            let weekRangeText;
            if (startOfWeek.getMonth() === endOfWeek.getMonth()) {
                // Same month
                weekRangeText = `${startMonth} ${startDay} - ${endDay}`;
            } else {
                // Different months
                weekRangeText = `${startMonth} ${startDay} - ${endMonth} ${endDay}`;
            }
            document.getElementById('weekRange').textContent = weekRangeText;
            
            // Filter entries for this week and month
            const weekEntries = entries.filter(e => {
                const entryDate = new Date(e.date + 'T00:00:00');
                return entryDate >= startOfWeek && entryDate <= endOfWeek;
            });
            
            const monthEntries = entries.filter(e => {
                const entryDate = new Date(e.date + 'T00:00:00');
                return entryDate.getFullYear() === currentYear && entryDate.getMonth() === currentMonth;
            });
            
            // Calculate week stats
            let weekPlanned = 0;
            let weekCompleted = 0;
            weekEntries.forEach(e => {
                if (e.plannedDuration) weekPlanned += e.plannedDuration;
                if (e.actualDuration && e.status === 'completed') weekCompleted += e.actualDuration;
            });
            
            // Calculate month stats
            let monthPlanned = 0;
            let monthCompleted = 0;
            monthEntries.forEach(e => {
                if (e.plannedDuration) monthPlanned += e.plannedDuration;
                if (e.actualDuration && e.status === 'completed') monthCompleted += e.actualDuration;
            });
            
            // Update week display
            document.getElementById('weekPlanned').textContent = `${weekPlanned} min`;
            document.getElementById('weekCompleted').textContent = `${weekCompleted} min`;
            const weekPercent = weekPlanned > 0 ? Math.round((weekCompleted / weekPlanned) * 100) : 0;
            document.getElementById('weekPercentage').textContent = `${weekPercent}%`;
            document.getElementById('weekProgress').style.width = `${Math.min(weekPercent, 100)}%`;
            
            // Update month display
            document.getElementById('monthPlanned').textContent = `${monthPlanned} min`;
            document.getElementById('monthCompleted').textContent = `${monthCompleted} min`;
            const monthPercent = monthPlanned > 0 ? Math.round((monthCompleted / monthPlanned) * 100) : 0;
            document.getElementById('monthPercentage').textContent = `${monthPercent}%`;
            document.getElementById('monthProgress').style.width = `${Math.min(monthPercent, 100)}%`;
        }

        // Open create modal for specific date (from calendar)
        function openCreateModalForDate(dateString) {
            openModalForDate(dateString);
        }

        // Render missed activities list
        function renderMissedList() {
            const entries = loadEntries();
            const missedList = document.getElementById('missedList');
            
            // Filter for missed activities
            let missedEntries = entries.filter(e => e.status === 'missed');
            
            // Update tag filters first
            updateMissedTagFilters(missedEntries);
            
            // Filter by tag if one is selected
            if (currentMissedTagFilter) {
                missedEntries = missedEntries.filter(entry => 
                    entry.tags && entry.tags.includes(currentMissedTagFilter)
                );
            }
            
            // Sort by date (newest first)
            const sorted = missedEntries.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (sorted.length === 0) {
                if (currentMissedTagFilter) {
                    missedList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üîç</div>
                            <h3>No Missed Activities with this tag</h3>
                            <p>Try selecting a different tag or view all</p>
                        </div>
                    `;
                } else {
                    missedList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">‚úì</div>
                            <h3>No Missed Activities</h3>
                            <p>You're doing great! Keep up the consistency!</p>
                        </div>
                    `;
                }
                return;
            }
            
            missedList.innerHTML = sorted.map(entry => {
                const tagsHtml = entry.tags && entry.tags.length > 0
                    ? `<div class="tags-container">
                        ${entry.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                       </div>`
                    : '';
                
                const reasonHtml = entry.missedReason
                    ? `<div class="missed-reason">"${entry.missedReason}"</div>`
                    : '';
                
                return `
                    <div class="missed-activity-card">
                        <div class="missed-activity-header">
                            <div>
                                <div class="missed-activity-title">${entry.title}</div>
                                <div class="missed-activity-date">${formatDate(entry.date)}</div>
                            </div>
                        </div>
                        
                        <div class="missed-activity-info">
                            <div class="missed-info-item">
                                <span class="missed-info-label">Planned Duration</span>
                                <span class="missed-info-value">${entry.plannedDuration || '‚Äî'} min</span>
                            </div>
                        </div>
                        
                        ${tagsHtml}
                        ${reasonHtml}
                    </div>
                `;
            }).join('');
        }

        // Update missed tag filter buttons
        function updateMissedTagFilters(missedEntries) {
            const allTags = new Set();
            
            missedEntries.forEach(entry => {
                if (entry.tags && Array.isArray(entry.tags)) {
                    entry.tags.forEach(tag => allTags.add(tag));
                }
            });
            
            const tagFiltersContainer = document.getElementById('missedTagFilters');
            
            if (allTags.size === 0) {
                tagFiltersContainer.innerHTML = '';
                return;
            }
            
            const sortedTags = Array.from(allTags).sort();
            
            tagFiltersContainer.innerHTML = `
                <button class="tag tag-filter ${currentMissedTagFilter === null ? 'active' : ''}" onclick="filterMissedByTag(null)">All</button>
                ${sortedTags.map(tag => `
                    <button class="tag tag-filter ${currentMissedTagFilter === tag ? 'active' : ''}" onclick="filterMissedByTag('${tag}')">${tag}</button>
                `).join('')}
            `;
        }

        // Filter missed activities by tag
        function filterMissedByTag(tag) {
            currentMissedTagFilter = tag;
            renderMissedList();
        }

        // API Key Management
        function openApiSettings() {
            const apiKey = localStorage.getItem(API_KEY_STORAGE);
            if (apiKey) {
                document.getElementById('apiKeyInput').value = apiKey;
            }
            document.getElementById('apiSettingsModal').classList.add('active');
        }
        
        function closeApiSettings() {
            document.getElementById('apiSettingsModal').classList.remove('active');
        }
        
        function saveApiKey() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            const statusDiv = document.getElementById('apiKeyStatus');
            
            if (!apiKey) {
                statusDiv.style.display = 'block';
                statusDiv.style.background = 'var(--bg-secondary)';
                statusDiv.style.color = 'var(--text)';
                statusDiv.textContent = 'Please enter an API key';
                return;
            }
            
            if (!apiKey.startsWith('sk-ant-')) {
                statusDiv.style.display = 'block';
                statusDiv.style.background = '#ffebee';
                statusDiv.style.color = '#c62828';
                statusDiv.textContent = 'Invalid API key format. Should start with sk-ant-';
                return;
            }
            
            localStorage.setItem(API_KEY_STORAGE, apiKey);
            statusDiv.style.display = 'block';
            statusDiv.style.background = '#e8f5e9';
            statusDiv.style.color = '#2e7d32';
            statusDiv.textContent = '‚úì API key saved successfully!';
            
            setTimeout(() => {
                closeApiSettings();
                statusDiv.style.display = 'none';
            }, 2000);
        }
        
        function clearApiKey() {
            localStorage.removeItem(API_KEY_STORAGE);
            document.getElementById('apiKeyInput').value = '';
            const statusDiv = document.getElementById('apiKeyStatus');
            statusDiv.style.display = 'block';
            statusDiv.style.background = 'var(--bg-secondary)';
            statusDiv.style.color = 'var(--text)';
            statusDiv.textContent = 'API key cleared';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 2000);
        }
        
        // AI Analysis
        async function analyzeProgress() {
            const apiKey = localStorage.getItem(API_KEY_STORAGE);
            
            if (!apiKey) {
                alert('Please set your Anthropic API key first. Click "‚öôÔ∏è API Settings" to get started.');
                openApiSettings();
                return;
            }
            
            const analyzeBtn = document.getElementById('analyzeBtn');
            analyzeBtn.disabled = true;
            analyzeBtn.textContent = 'ü§ñ Analyzing...';
            
            try {
                // Get recent entries (last 30 days)
                const entries = loadEntries();
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                
                const recentEntries = entries.filter(e => {
                    const entryDate = new Date(e.date);
                    return entryDate >= thirtyDaysAgo;
                }).sort((a, b) => new Date(a.date) - new Date(b.date));
                
                if (recentEntries.length === 0) {
                    alert('No entries found in the last 30 days. Create some entries first!');
                    analyzeBtn.disabled = false;
                    analyzeBtn.textContent = 'ü§ñ Analyze My Progress';
                    return;
                }
                
                // Prepare data for Claude
                const entrySummary = recentEntries.map(e => {
                    const type = e.type || 'workout';
                    const status = e.status || 'completed';
                    return `Date: ${e.date}
Type: ${type}
Title: ${e.title}
Status: ${status}
${e.actualDuration ? `Duration: ${e.actualDuration} minutes` : ''}
${e.weight ? `Weight: ${e.weight} kg` : ''}
${e.tags && e.tags.length > 0 ? `Tags: ${e.tags.join(', ')}` : ''}
${e.notes ? `Notes: ${e.notes}` : ''}
${status === 'missed' && e.missedReason ? `Reason missed: ${e.missedReason}` : ''}
---`;
                }).join('\n\n');
                
                const prompt = `You are analyzing fitness and life journal entries for Tyler Brown. He's 41, 6'4", currently 211 lbs with a goal of 190 lbs. He's returning to fitness after a 3-month break.

Here are his entries from the last 30 days:

${entrySummary}

Please provide a thoughtful, encouraging analysis covering:
1. Overall consistency and patterns
2. Physical progress observations (workout frequency, duration trends)
3. Mental/emotional state based on journal entries
4. Any concerning patterns (frequent missed workouts, reasons for missing)
5. Specific, actionable encouragement and suggestions

Keep it personal, direct, and motivating. Be honest but supportive. Format as natural paragraphs, not bullet points.`;
                
                // Call Anthropic API
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1000,
                        messages: [{
                            role: 'user',
                            content: prompt
                        }]
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || 'API request failed');
                }
                
                const data = await response.json();
                const analysis = data.content[0].text;
                
                // Display result
                document.getElementById('analysisContent').textContent = analysis;
                document.getElementById('analysisResult').style.display = 'block';
                
                // Scroll to result
                document.getElementById('analysisResult').scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                console.error('Analysis error:', error);
                alert(`Analysis failed: ${error.message}\n\nMake sure your API key is valid and you have credits available.`);
            } finally {
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = 'ü§ñ Analyze My Progress';
            }
        }

        // Password Protection
        const CORRECT_PASSWORD = 'persistence2026'; // Change this to whatever password you want
        
        // Export/Import Data
        function exportData() {
            const entries = loadEntries();
            
            if (entries.length === 0) {
                alert('No data to export. Create some entries first!');
                return;
            }
            
            const dataStr = JSON.stringify(entries, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `tyler-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert(`Exported ${entries.length} entries successfully!`);
        }
        
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedEntries = JSON.parse(e.target.result);
                    
                    if (!Array.isArray(importedEntries)) {
                        throw new Error('Invalid data format');
                    }
                    
                    const currentEntries = loadEntries();
                    const confirm = window.confirm(
                        `You have ${currentEntries.length} existing entries.\n` +
                        `Import will add ${importedEntries.length} entries from the file.\n\n` +
                        `Continue?`
                    );
                    
                    if (!confirm) return;
                    
                    // Merge entries, avoiding duplicates by ID
                    const existingIds = new Set(currentEntries.map(e => e.id));
                    const newEntries = importedEntries.filter(e => !existingIds.has(e.id));
                    const mergedEntries = [...currentEntries, ...newEntries];
                    
                    saveEntries(mergedEntries);
                    
                    alert(`Successfully imported ${newEntries.length} new entries!`);
                    renderGrid();
                    renderCalendar();
                    updateTagFilters();
                } catch (error) {
                    console.error('Import error:', error);
                    alert('Failed to import data. Make sure the file is a valid backup file.');
                }
            };
            reader.readAsText(file);
            
            // Reset file input so same file can be selected again if needed
            event.target.value = '';
        }
        
        function checkPassword() {
            const input = document.getElementById('passwordInput').value;
            const errorDiv = document.getElementById('passwordError');
            
            if (input === CORRECT_PASSWORD) {
                document.getElementById('passwordScreen').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                localStorage.setItem('tracker-authenticated', 'true');
            } else {
                errorDiv.style.display = 'block';
                document.getElementById('passwordInput').value = '';
                document.getElementById('passwordInput').focus();
                
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 3000);
            }
        }
        
        // Check if already authenticated
        function checkAuth() {
            if (localStorage.getItem('tracker-authenticated') === 'true') {
                document.getElementById('passwordScreen').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
            } else {
                document.getElementById('passwordInput').focus();
            }
        }

        // Initialize on load
        checkAuth();
        init();
    </script>
    
    </div> <!-- Close mainContent -->
</body>
</html>